# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!
source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface eno1 inet manual
iface eno2 inet manual
iface eno3 inet manual
iface eno4 inet manual

auto vmbr0
iface vmbr0 inet static
        address 192.168.0.250/24
        gateway 192.168.0.1
        bridge-ports eno1
        bridge-stp off
        bridge-fd 0
        bridge-vlan-aware yes
        bridge-vids 2-4094
#Connects to the NiC

auto vmbr1
iface vmbr1 inet static
        address 10.150.50.1/24
        bridge-ports none
        bridge-stp off
        bridge-fd 0

# Purpose: Routed internal network for containers/VMs that should go through VPN
        # Enable forwarding
        post-up   echo 1 > /proc/sys/net/ipv4/ip_forward

        # NAT vmbr1 subnet out through the VPN interface (pia)
        #post-up   iptables -t nat -A POSTROUTING -s '10.150.50.0/24' -o vmbr0 -j MASQUERADE
        #post-down iptables -t nat -D POSTROUTING -s '10.150.50.0/24' -o vmbr0 -j MASQUERADE
        post-up   iptables -t nat -A POSTROUTING -s '10.150.50.0/24' -o pia -j MASQUERADE
        post-down iptables -t nat -D POSTROUTING -s '10.150.50.0/24' -o pia -j MASQUERADE
        # post-up   iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
        # post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1

        # Forwarding rules for VPN traffic
        # Currently set to PIA VPN setup through wireguard on Proxmox Host
        post-up   iptables -A FORWARD -i vmbr1 -o pia -j ACCEPT
        post-down iptables -D FORWARD -i vmbr1 -o pia -j ACCEPT

        post-up   iptables -A FORWARD -i pia -o vmbr1 -m state --state RELATED,ESTABLISHED -j ACCEPT
        post-down iptables -D FORWARD -i pia -o vmbr1 -m state --state RELATED,ESTABLISHED -j ACCEPT

        # Kill-switch: block any non-VPN egress from vmbr1
        post-up   iptables -A FORWARD -i vmbr1 ! -o pia -j REJECT
        post-down iptables -D FORWARD -i vmbr1 ! -o pia -j REJECT
