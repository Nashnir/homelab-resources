# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!
source /etc/network/interfaces.d/*

## Loopback Interface
auto lo
iface lo inet loopback

## Physical NICs (no addresses here; IP lives on vmbr0)
iface eno1 inet manual
iface eno2 inet manual
iface eno3 inet manual
iface eno4 inet manual

## Management bridge on LAN (no VLAN filtering)
auto vmbr0
iface vmbr0 inet static
        address 192.168.0.250/24
        gateway 192.168.0.1
        bridge-ports eno1
        bridge-stp off
        bridge-fd 0
        # VLAN awareness removed on purpose

## Routed internal network for guests that must egress via VPN
auto vmbr1
iface vmbr1 inet static
        address 10.150.50.1/24
        bridge-ports none
        bridge-stp off
        bridge-fd 0

        # /etc/sysctl.d/99-forward.conf â†’ net.ipv4.ip_forward=1 then sysctl --system
        #post-up   echo 1 > /proc/sys/net/ipv4/ip_forward
        #post-down echo 0 > /proc/sys/net/ipv4/ip_forward

        # ---- Conntrack baseline: allow established/related first ----
        post-up   iptables -C FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT || iptables -I FORWARD 1 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
        post-down iptables -D FORWARD    -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT || true

        # ---- Pi-hole (192.168.0.50) -> Unbound (10.150.50.5) across bridges ----
        # If Unbound listens on port 53, use these:
        #post-up   iptables -A FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p udp --dport 53 -j ACCEPT
        #post-up   iptables -A FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p tcp --dport 53 -j ACCEPT
        #post-down iptables -D FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p udp --dport 53 -j ACCEPT
        #post-down iptables -D FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p tcp --dport 53 -j ACCEPT

        # If Unbound listens on 5335 instead, comment the four rules above and use these four:
        # post-up   iptables -A FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p udp --dport 5335 -j ACCEPT
        # post-up   iptables -A FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p tcp --dport 5335 -j ACCEPT
        # post-down iptables -D FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p udp --dport 5335 -j ACCEPT
        # post-down iptables -D FORWARD -i vmbr0 -o vmbr1 -s 192.168.0.50 -d 10.150.50.5 -p tcp --dport 5335 -j ACCEPT

        # SNAT Pi-hole DNS to Unbound so replies return (no LAN router route needed)
        #post-up   iptables -t nat -A POSTROUTING -s 192.168.0.50 -d 10.150.50.5 -o vmbr1 -j MASQUERADE
        #post-down iptables -t nat -D POSTROUTING -s 192.168.0.50 -d 10.150.50.5 -o vmbr1 -j MASQUERADE

        # ---- VPN egress for vmbr1 ----
        # Allow new connections from internal (vmbr1) to VPN interface (pia)
        post-up   iptables -C FORWARD -i vmbr1 -o pia -j ACCEPT || iptables -A FORWARD -i vmbr1 -o pia -j ACCEPT
        post-down iptables -D FORWARD -i vmbr1 -o pia -j ACCEPT || true

        # NAT vmbr1 subnet out via VPN (pia)
        post-up   iptables -t nat -C POSTROUTING -s 10.150.50.0/24 -o pia -j MASQUERADE || iptables -t nat -A POSTROUTING -s 10.150.50.0/24 -o pia -j MASQUERADE
        post-down iptables -t nat -D POSTROUTING -s 10.150.50.0/24 -o pia -j MASQUERADE || true

        # Allow intra-vmbr1 traffic (guests talking to each other / to Unbound on 10.150.50.5)
        post-up   iptables -C FORWARD -i vmbr1 -o vmbr1 -j ACCEPT || iptables -A FORWARD -i vmbr1 -o vmbr1 -j ACCEPT
        post-down iptables -D FORWARD -i vmbr1 -o vmbr1 -j ACCEPT || true

        # (Optional) allow vmbr1 guests to reach Proxmox GUI at 192.168.0.250
        # post-up   iptables -A FORWARD -i vmbr1 -o vmbr0 -d 192.168.0.250 -j ACCEPT
        # post-down iptables -D FORWARD -i vmbr1 -o vmbr0 -d 192.168.0.250 -j ACCEPT

        # Kill-switch: block any non-VPN egress from vmbr1 (must come after the accepts)
        post-up   iptables -C FORWARD -i vmbr1 ! -o pia -j REJECT || iptables -A FORWARD -i vmbr1 ! -o pia -j REJECT
        post-down iptables -D FORWARD -i vmbr1 ! -o pia -j REJECT || true